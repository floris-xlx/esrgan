<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Upscaler</title>
    <style>
      .image-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
      }
      .image-section {
        flex: 1;
        min-width: 300px;
        text-align: center;
      }
      .image-section h3 {
        margin-bottom: 10px;
      }
      .image-section img {
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .download-button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      .download-button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <h1>Upload an Image to Upscale</h1>
    <form id="uploadForm" enctype="multipart/form-data">
      <input
        type="file"
        id="imageFile"
        name="imageFile"
        accept="image/*"
        required
      />
      <button type="button" onclick="uploadImage()">Upload and Upscale</button>
    </form>
    <div id="response"></div>
    <div id="upscaledImageContainer"></div>

    <script>
      let originalImageUrl = null;

      async function uploadImage() {
        const fileInput = document.getElementById("imageFile");
        const file = fileInput.files[0];
        if (!file) {
          alert("Please select an image file to upload.");
          return;
        }

        // Store the original image URL for display
        originalImageUrl = URL.createObjectURL(file);

        const formData = new FormData();
        formData.append("imageFile", file);

        try {
          const response = await fetch("http://localhost:3443/upscale", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          document.getElementById("response").innerText = `Request ID: ${result.data.request_id}`;

          const fileExtension = file.name.split('.').pop();
          checkStatus(result.data.request_id, fileExtension);
        } catch (error) {
          console.error("Error uploading image:", error);
          document.getElementById("response").innerText =
            `Error uploading image: ${error.message}`;
        }
      }

      async function checkStatus(requestId, fileExtension) {
        try {
          const statusResponse = await fetch(`http://localhost:3443/status/${requestId}`);
          if (!statusResponse.ok) {
            throw new Error(`HTTP error! status: ${statusResponse.status}`);
          }

          const statusResult = await statusResponse.json();
          document.getElementById("response").innerText = `Status: ${statusResult.status}`;

          if (statusResult.status === "Completed") {
            const upscaledImageUrl = `C:/Users/floris/Documents/GitHub/esrgan/cache/${requestId}.${fileExtension}`;
            
            // Create the side-by-side image display
            const imageContainer = document.createElement("div");
            imageContainer.className = "image-container";

            // Original image section
            const originalSection = document.createElement("div");
            originalSection.className = "image-section";
            const originalTitle = document.createElement("h3");
            originalTitle.textContent = "Original Image";
            const originalImg = document.createElement("img");
            originalImg.src = originalImageUrl;
            originalImg.alt = "Original Image";
            originalSection.appendChild(originalTitle);
            originalSection.appendChild(originalImg);

            // Upscaled image section
            const upscaledSection = document.createElement("div");
            upscaledSection.className = "image-section";
            const upscaledTitle = document.createElement("h3");
            upscaledTitle.textContent = "Upscaled Image";
            const upscaledImg = document.createElement("img");
            upscaledImg.src = upscaledImageUrl;
            upscaledImg.alt = "Upscaled Image";
            upscaledSection.appendChild(upscaledTitle);
            upscaledSection.appendChild(upscaledImg);

            imageContainer.appendChild(originalSection);
            imageContainer.appendChild(upscaledSection);

            // Download button
            const downloadButton = document.createElement("button");
            downloadButton.className = "download-button";
            downloadButton.textContent = "Download Upscaled Image";
            downloadButton.onclick = () => downloadImage(upscaledImageUrl, `upscaled_${requestId}.${fileExtension}`);

            // Clear container and add new content
            const container = document.getElementById("upscaledImageContainer");
            container.innerHTML = "";
            container.appendChild(imageContainer);
            container.appendChild(downloadButton);
          } else if (statusResult.status === "Processing") {
            setTimeout(() => checkStatus(requestId, fileExtension), 2000); // Check again after 2 seconds
          }
        } catch (error) {
          console.error("Error checking status:", error);
          document.getElementById("response").innerText =
            `Error checking status: ${error.message}`;
        }
      }

      function downloadImage(imageUrl, filename) {
        const link = document.createElement("a");
        link.href = imageUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>
  </body>
</html>